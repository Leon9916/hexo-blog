---
title: å“åº”å¼åŸç†ï¼šå‰¯ä½œç”¨å‡½æ•°æ¢ç§˜
recommend: 7
toc: true
keywords: categories-tool
thumbnail: 'https://cdn-us.imgs.moe/2023/05/26/646f9fde38e7e.png'
tags: å‰ç«¯
categories:
    - å‰ç«¯
    - æ·±å…¥Vue3åŸç†
abbrlink: 91e84f90
date: 2022-08-17 19:13:16
---

> æˆ‘ä»¬è¯´åˆ°äº†Â [Reactive]{.mark}Â ä¼šåœ¨Â [proxy
getter]{.mark}Â çš„æ—¶å€™æ”¶é›†Â [effect]{.mark}Â ä¾èµ–ï¼Œåœ¨Â [proxy
setter]{.mark}Â çš„æ—¶å€™è§¦å‘Â [effect]{.mark}Â çš„æ‰§è¡Œã€‚é‚£ä¹ˆÂ [effect]{.mark}Â å‰¯ä½œç”¨å‡½æ•°åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆï¼Ÿä»¥åŠæ˜¯å¦‚ä½•è¢«æ”¶é›†èµ·æ¥çš„å‘¢ï¼Ÿ
<!-- more -->

**å‰è¨€**

æˆ‘ä»¬è¯´åˆ°äº†Â [Reactive]{.mark}Â ä¼šåœ¨Â [proxy
getter]{.mark}Â çš„æ—¶å€™æ”¶é›†Â [effect]{.mark}Â ä¾èµ–ï¼Œåœ¨Â [proxy
setter]{.mark}Â çš„æ—¶å€™è§¦å‘Â [effect]{.mark}Â çš„æ‰§è¡Œã€‚é‚£ä¹ˆÂ [effect]{.mark}Â å‰¯ä½œç”¨å‡½æ•°åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆï¼Ÿä»¥åŠæ˜¯å¦‚ä½•è¢«æ”¶é›†èµ·æ¥çš„å‘¢ï¼Ÿ

**effect**

æ‰¾åˆ°æºç ä¸­å…³äºÂ [effect]{.mark}Â éƒ¨åˆ†çš„å®šä¹‰ï¼š

export function effect (fn, options) {

// å¦‚æœ fn å·²ç»æ˜¯ä¸€ä¸ª effect å‡½æ•°äº†ï¼Œåˆ™æŒ‡å‘åŸå§‹å‡½æ•°

if (fn.effect) {

fn = fn.effect.fn

}

// æ„é€  \_effect å®ä¾‹

const \_effect = new ReactiveEffect(fn)

// options åˆå§‹åŒ–

if (options) {

extend(\_effect, options)

if (options.scope) recordEffectScope(\_effect, options.scope)

}

// å¦‚æœ‰ options æˆ–è€… ä¸æ˜¯æ‡’åŠ è½½ï¼Œæ‰§è¡Œ \_effect.run()

if (!options \|\| !options.lazy) {

\_effect.run()

}

// è¿”å› \_effect.run

const runner = \_effect.run.bind(\_effect)

runner.effect = \_effect

return runner

}

è¿™ä¸ªÂ [effect]{.mark}Â å‡½æ•°å†…éƒ¨æ ¸å¿ƒæ˜¯é€šè¿‡Â [ReactiveEffect]{.mark}Â ç±»åˆ›å»ºäº†ä¸€ä¸ªÂ [\_effect]{.mark}Â å®ä¾‹ï¼Œä»ä»£ç æ¥çœ‹ï¼Œ[\_effect]{.mark}Â ä¸ŠåŒ…å«äº†ä¸€ä¸ªÂ [run]{.mark}Â å‡½æ•°ã€‚é»˜è®¤Â [effect]{.mark}Â æ˜¯æ²¡æœ‰ä¼ å…¥Â [options]{.mark}Â å‚æ•°çš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥æ‰§è¡Œäº†Â [\_effect.run()]{.mark}ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ[fn]{.mark}Â å‡½æ•°æ˜¯åœ¨Â [effect]{.mark}Â å‡½æ•°ä¸­çš„ä¸€ä¸ªå…¥å‚ï¼Œæ¯”å¦‚ï¼š

const state = reactive({a: 1})

effect(() =\> console.log(state.a))

æ ¹æ®ä¸Šä¸€å°èŠ‚ï¼Œæˆ‘ä»¬çŸ¥é“å› ä¸ºè¿™é‡Œæˆ‘ä»¬è®¿é—®äº†Â [state.a]{.mark}Â æ‰€ä»¥æ”¶é›†äº†å‰¯ä½œç”¨å‡½æ•°ï¼Œä½†æ˜¯éœ€è¦çŸ¥é“çš„æ˜¯è¿™é‡Œçš„Â [effect]{.mark}Â ä¼ å…¥çš„æ˜¯ä¸€ä¸ªÂ [fn]{.mark}ï¼Œæ‰€ä»¥è¦æƒ³è®¿é—®Â [state.a]{.mark}Â é‚£è¿™ä¸ªÂ [fn]{.mark}Â å¿…é¡»è¦æ‰§è¡Œæ‰å¯ä»¥ã€‚é‚£æ˜¯åœ¨å“ªé‡Œæ‰§è¡Œçš„å‘¢ï¼Ÿæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Â [ReactiveEffect]{.mark}Â çš„å®ç°ï¼š

// ç”¨äºè®°å½•ä½äºå“åº”ä¸Šä¸‹æ–‡ä¸­çš„effectåµŒå¥—å±‚æ¬¡æ•°

let effectTrackDepth = 0

// äºŒè¿›åˆ¶ä½ï¼Œæ¯ä¸€ä½ç”¨äºæ ‡è¯†å½“å‰effectåµŒå¥—å±‚çº§çš„ä¾èµ–æ”¶é›†çš„å¯ç”¨çŠ¶æ€

export left trackOpBit = 1

// è¡¨ç¤ºæœ€å¤§æ ‡è®°çš„ä½æ•°

const maxMarkerBits = 30

// å½“å‰æ´»è·ƒçš„ effect

let activeEffect;

export class ReactiveEffect {

// ç”¨äºæ ‡è¯†å‰¯ä½œç”¨å‡½æ•°æ˜¯å¦ä½äºå“åº”å¼ä¸Šä¸‹æ–‡ä¸­è¢«æ‰§è¡Œ

active = true

// å‰¯ä½œç”¨å‡½æ•°æŒæœ‰å®ƒæ‰€åœ¨çš„æ‰€æœ‰ä¾èµ–é›†åˆçš„å¼•ç”¨ï¼Œç”¨äºä»è¿™äº›ä¾èµ–é›†åˆåˆ é™¤è‡ªèº«

deps = \[\]

// æŒ‡é’ˆä¸ºï¼Œç”¨äºåµŒå¥— effect æ‰§è¡ŒååŠ¨æ€åˆ‡æ¢ activeEffect

parent = undefined

// \...

run() {

// è‹¥å½“å‰ ReactiveEffect å¯¹è±¡è„±ç¦»å“åº”å¼ä¸Šä¸‹æ–‡

// é‚£ä¹ˆå…¶å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°è¢«æ‰§è¡Œæ—¶ä¸ä¼šå†æ”¶é›†ä¾èµ–

if (!this.active) {

return this.fn()

}

// ç¼“å­˜æ˜¯å¦éœ€è¦æ”¶é›†ä¾èµ–

let lastShouldTrack = shouldTrack

try {

// ä¿å­˜ä¸Šä¸€ä¸ª activeEffect åˆ°å½“å‰çš„ parent ä¸Š

this.parent = activeEffect

// activeEffect æŒ‡å‘å½“å‰çš„ effect

activeEffect = this

// shouldTrack ç½®æˆ true

shouldTrack = true

// å·¦ç§»æ“ä½œç¬¦ \<\<Â å°†ç¬¬ä¸€ä¸ªæ“ä½œæ•°å‘å·¦ç§»åŠ¨æŒ‡å®šä½æ•°

// å·¦è¾¹è¶…å‡ºçš„ä½æ•°å°†ä¼šè¢«æ¸…é™¤ï¼Œå³è¾¹å°†ä¼šè¡¥é›¶ã€‚

// trackOpBit æ˜¯åŸºäº 1 å·¦ç§» effectTrackDepth ä½

trackOpBit = 1 \<\< ++effectTrackDepth

// å¦‚æœæœªè¶…è¿‡æœ€å¤§åµŒå¥—å±‚æ•°ï¼Œåˆ™æ‰§è¡Œ initDepMarkers

if (effectTrackDepth \<= maxMarkerBits) {

initDepMarkers(this)

} else {

cleanupEffect(this)

}

// è¿™é‡Œæ‰§è¡Œäº† fn

return this.fn()

} finally {

if (effectTrackDepth \<= maxMarkerBits) {

// ç”¨äºå¯¹æ›¾ç»è·Ÿè¸ªè¿‡ï¼Œä½†æœ¬æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶æ²¡æœ‰è·Ÿè¸ªçš„ä¾èµ–é‡‡å–åˆ é™¤æ“ä½œã€‚

// æ–°è·Ÿè¸ªçš„ å’Œ æœ¬è½®è·Ÿè¸ªè¿‡çš„éƒ½ä¼šè¢«ä¿ç•™

finalizeDepMarkers(this)

}

// \<\< \--effectTrackDepth å³ç§»åŠ¨ effectTrackDepth ä½

trackOpBit = 1 \<\< \--effectTrackDepth

// è¿”å›ä¸Šä¸ª activeEffect

activeEffect = this.parent

// è¿”å›ä¸Šä¸ª shouldTrack

shouldTrack = lastShouldTrack

// æƒ…å†µæœ¬æ¬¡çš„ parent æŒ‡å‘

this.parent = undefined

}

}

}

å¤§è‡´çœ‹ä¸€çœ¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨Â [ReactiveEffect]{.mark}Â ä¸­æ˜¯æ‰§è¡Œäº†Â [this.fn()]{.mark}Â çš„ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†Â [effect]{.mark}Â ä¸­çš„å›è°ƒå‡½æ•°Â [fn]{.mark}Â æ˜¯åœ¨è¿™é‡Œè¢«è°ƒç”¨çš„ã€‚æ¥ä¸‹æ¥è¯¦ç»†ç ”ç©¶ä¸€ä¸‹è¿™ä¸ªÂ [ReactiveEffect]{.mark}ã€‚

ä½†è¿™æ®µä»£ç çœ‹èµ·æ¥ä¸æ˜¯å¾ˆé•¿ï¼Œä½†æ¶‰åŠäº†å¥½å‡ ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªä¸ªçœ‹ã€‚

**1. parent çš„ä½œç”¨**

ä¸ºä»€ä¹ˆÂ [ReactiveEffect]{.mark}Â è¦è®¾è®¡ä¸€ä¸ªÂ [parent]{.mark}Â è¿™æ ·ä¸€ä¸ªçœ‹ä¼¼æ²¡å•¥ç”¨çš„å˜é‡æŒ‡é’ˆæ¥å­˜å‚¨ä¸Šä¸€æ¬¡çš„Â [activeEffect]{.mark}Â å‘¢ï¼Ÿå¦‚æœæ”¹æˆä¸‹é¢è¿™æ ·ä¸æ˜¯æ›´ç®€å•å—ï¼Ÿ

run() {

if (!this.active) {

return this.fn();

}

// åˆå§‹åŒ–

shouldTrack = true;

activeEffect = this;

const result = this.fn();

// é‡ç½®

shouldTrack = false;

return result;

}

å…¶å®å¯¹äºä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š

const state = reactive({a: 1})

effect(() =\> console.log(state.a))

state.a++

[effect]{.mark}Â å‡½æ•°å†…è°ƒç”¨Â [ReactiveEffect]{.mark}Â å®ä¾‹çš„Â [run]{.mark}Â å‡½æ•°ã€‚[run]{.mark}Â å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼ŒæŠŠÂ [activeEffect]{.mark}Â æŒ‡å‘Â [this]{.mark}ã€‚ç„¶åæ‰§è¡ŒÂ [effect]{.mark}Â ä¼ å…¥çš„Â [fn]{.mark}Â å‡½æ•°ï¼Œå‡½æ•°åœ¨æ‰§è¡Œçš„æ—¶å€™è®¿é—®äº†Â [state.a]{.mark}Â è§¦å‘äº†Â [getter]{.mark}Â é’©å­ã€‚å›é¡¾ä¸€ä¸‹ä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œ[getter]{.mark}Â çš„æ—¶å€™æœ‰è§¦å‘æ·»åŠ Â [activeEffect]{.mark}Â çš„åŠŸèƒ½ï¼š

// æŠŠ activeEffect æ·»åŠ åˆ° dep ä¸­

dep.add(activeEffect!)

è€ŒÂ [activeEffect]{.mark}Â æ­£æ˜¯è¿™é‡Œçš„Â [this]{.mark}ã€‚å½“æ‰§è¡ŒÂ [state.a++]{.mark}Â æ—¶ï¼Œè®¿é—®äº†[state.a]{.mark}Â çš„Â [setter]{.mark}ã€‚ä¸Šä¸€èŠ‚ä¹Ÿè¯´äº†ï¼Œ[setter]{.mark}Â çš„æ‰§è¡Œä¼šè°ƒç”¨Â [effect.run]{.mark}Â å‡½æ•°ï¼š

// triggerEffects

effect.run();

æ‰€ä»¥åˆä¼šæ‰§è¡ŒÂ [fn]{.mark}ã€‚

åˆ°è¿™é‡Œçœ‹ä¼¼å¾ˆå®Œç¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­ğŸŒ°ï¼š

const state = reactive({

a: 1,

b: 2

});

// ef1

effect(() =\> {

// ef2

effect(() =\> console.log(\`b: \${state.b}\`))

console.log(\`a: \${state.a}\`)

});

state.a ++

æŒ‰ç…§ä¸Šé¢çš„é€»è¾‘ï¼Œåœ¨ç¬¬ä¸€æ¬¡Â [effect]{.mark}Â æ‰§è¡Œçš„æ—¶å€™ï¼Œ[activeEffect =
ef1]{.mark}Â ç„¶åå†æ‰§è¡Œå†…éƒ¨çš„Â [effect]{.mark}ï¼Œ æ­¤æ—¶Â [activeEffect =
ef2]{.mark}Â ç„¶åÂ [ef2]{.mark}Â æ‰§è¡Œå®Œæˆå›åˆ°Â [ef1]{.mark}Â å‡½æ•°ä½“å†…ï¼Œæ­¤æ—¶å†è®¿é—®Â [state.a]{.mark}Â è§¦å‘å¯¹Â [a]{.mark}Â çš„ä¾èµ–æ”¶é›†ï¼Œä½†æ”¶é›†åˆ°çš„å´æ˜¯Â [ef2]{.mark}ã€‚é‚£ä¹ˆæœ€ç»ˆæ‰“å°çš„æ˜¯ï¼š

b: 2

a: 1

b: 2

å¾ˆæ˜æ˜¾ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯è¾“å‡ºï¼š

b: 2

a: 1

b: 2

a: 2

è¿™æ—¶å€™Â [parent]{.mark}Â å°±æ’ä¸Šç”¨åœºäº†ï¼Œå½“ä¸ºÂ [effect]{.mark}Â åŠ ä¸ŠÂ [parent]{.mark}Â å±æ€§åï¼Œæˆ‘ä»¬å†æ¥æ‹ä¸€ä¸‹æ•´ä½“çš„æµç¨‹ã€‚

æ‰§è¡ŒÂ 

ef1Â çš„æ—¶å€™ï¼Œ

activeEffectÂ æŒ‡å‘Â 

ef1ï¼Œæ­¤æ—¶Â 

parentÂ æ˜¯Â 

undefinedã€‚

æ‰§è¡ŒÂ 

ef1 fnÂ é‡åˆ°äº†Â 

ef2ï¼Œè°ƒç”¨Â 

ef2Â æ­¤æ—¶Â 

ef2Â çš„Â 

parentÂ æŒ‡å‘Â 

ef1ï¼ŒÂ 

activeEffectÂ æŒ‡å‘Â 

ef2ã€‚ç„¶åæ‰§è¡ŒÂ 

ef2 çš„ fnã€‚

ef2 çš„ fnÂ æ‰§è¡Œçš„æ—¶å€™ï¼Œè®¿é—®äº†Â 

state.bÂ ä¾èµ–æ”¶é›†Â 

ef2ã€‚æ‰§è¡Œå®Œæˆåï¼Œ

activeEffect = this.parentÂ åˆæŠŠÂ 

activeEffectÂ æŒ‡å‘äº†Â 

ef1ã€‚

è¿”å›Â 

ef1Â çš„Â 

fnÂ ä½“ç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶è®¿é—®Â 

state.aÂ ä¾èµ–æ”¶é›†Â 

activeEffectÂ ä¸ºÂ 

ef1ã€‚

è§¦å‘Â 

state.aÂ çš„Â 

setterï¼Œè°ƒç”¨Â 

aÂ çš„å‰¯ä½œç”¨Â 

ef1ï¼Œä¾æ¬¡æ‰“å°......

åˆ°è¿™é‡Œç›¸ä¿¡å„ä½å°ä¼™ä¼´å·²ç»æ¸…æ¥šäº†Â [parent]{.mark}Â çš„ä½œç”¨äº†ï¼Œé‚£å°±æ˜¯**é€šè¿‡Â [parent]{.mark}Â è¿™ä¸ªæ ‡è®°ï¼Œæ¥å›åˆ‡æ¢Â [activeEffect]{.mark}Â çš„æŒ‡å‘ï¼Œä»è€Œå®Œæˆå¯¹åµŒå¥—Â [effect]{.mark}Â çš„æ­£ç¡®çš„ä¾èµ–æ”¶é›†**ã€‚

**2. ä¾èµ–æ¸…ç†**

åœ¨è¯´ä¾èµ–æ¸…ç†ä¹‹å‰ï¼Œå†æ¥çœ‹ä¸€ä¸ªæœ‰æ„æ€çš„ä¾‹å­ï¼š

const state = reactive({

a: 1,

show: true

});

effect(() =\> {

if (state.show) {

console.log(\`a: \${state.a}\`)

}

});

state.a ++

setTimeout(() =\> {

state.show = false

state.a ++

}, 1000)

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨Â [effect]{.mark}Â ä¸­å®Œæˆäº†å¯¹Â [show]{.mark}Â å’ŒÂ [a]{.mark}Â çš„ä¾èµ–æ”¶é›†ï¼Œç„¶åÂ [1s]{.mark}Â åï¼Œæˆ‘ä»¬æ”¹å˜äº†Â [show]{.mark}Â çš„çŠ¶æ€ä¸ºÂ [false]{.mark}ã€‚æ­¤æ—¶Â [effect]{.mark}Â å†…çš„å‡½æ•°ä¸­çš„Â [console.log]{.mark}Â å°†æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œç„¶åå†è§¦å‘Â [state.a++]{.mark}Â çš„åŠ¨ä½œï¼Œè®¿é—®Â [a]{.mark}Â çš„Â [getter]{.mark}ï¼Œå¦‚æœæ²¡æœ‰ä¾èµ–æ¸…ç†ï¼Œé‚£ä¹ˆæŒ‰ç…§ä¹‹å‰çš„åšæ³•ï¼Œæµ‹è¯•ä¹Ÿä¼šè§¦å‘Â [effect.fn]{.mark}Â çš„æ‰§è¡Œï¼Œä½†è¿™ä¸ªæ‰§è¡Œå…¶å®æ²¡æ„ä¹‰çš„ï¼Œå› ä¸ºÂ [a]{.mark}Â å·²ç»æ²¡æœ‰è¢«ä½¿ç”¨äº†ï¼Œæ˜¯ä¸€ä¸ªæ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°çš„å˜é‡ï¼Œé€ æˆäº†æ€§èƒ½æµªè´¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ é™¤Â [a]{.mark}Â çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè®©å®ƒä¸è¦æ‰§è¡Œã€‚

æ¥ä¸‹æ¥ä¸€èµ·æ¥çœ‹çœ‹Â [Vue]{.mark}Â æ˜¯æ€ä¹ˆåšçš„å§ï¼è¿™é‡Œæ¶‰åŠåˆ°çš„å†…å®¹æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬å…ˆä¸€ä¸ªä¸ªè§£é‡Šï¼Œé¦–å…ˆè¡¥ä¹ ä¸€ä¸‹å…³äºÂ [js]{.mark}Â çš„ä¸€äº›æ“ä½œç¬¦çš„åŸºç¡€çŸ¥è¯†ã€‚

**1. å·¦ç§»ï¼ˆ\<\<ï¼‰**

å·¦ç§»æ“ä½œç¬¦ ([\<\<]{.mark})Â å°†ç¬¬ä¸€ä¸ªæ“ä½œæ•°è½¬æ¢æˆ 2
è¿›åˆ¶åå‘å·¦ç§»åŠ¨æŒ‡å®šä½æ•°ï¼Œå·¦è¾¹è¶…å‡ºçš„ä½æ•°å°†ä¼šè¢«æ¸…é™¤ï¼Œå³è¾¹å°†ä¼šè¡¥é›¶ã€‚

const a = 1; // 00000000000000000000000000000001

const b = 1;

console.log(a \<\< b); // 00000000000000000000000000000010

// expected output: 2

**2. ä½æˆ–æ“ä½œï¼ˆ\|ï¼‰**

ä½æˆ–æ“ä½œç¬¦ï¼ˆ\|ï¼‰ï¼Œ å¦‚æœä¸¤ä½ä¹‹ä¸€ä¸º 1ï¼Œåˆ™è®¾ç½®æ¯ä½ä¸º 1ã€‚

const a = 5; // 00000000000000000000000000000101

const b = 3; // 00000000000000000000000000000011

console.log(a \| b); // 00000000000000000000000000000111

// expected output: 7

**3. æŒ‰ä½ä¸ï¼ˆ&ï¼‰**

æŒ‰ä½ä¸è¿ç®—ç¬¦ ([&]{.mark})
åœ¨ä¸¤ä¸ªæ“ä½œæ•°å¯¹åº”çš„äºŒè¿›ä½éƒ½ä¸ºÂ [1]{.mark}Â æ—¶ï¼Œè¯¥ä½çš„ç»“æœå€¼æ‰ä¸ºÂ [1]{.mark}ï¼Œå¦åˆ™ä¸ºÂ [0]{.mark}ã€‚

const a = 5; // 00000000000000000000000000000101

const b = 3; // 00000000000000000000000000000011

console.log(a & b); // 00000000000000000000000000000001

// expected output: 1

**4. æŒ‰ä½éï¼ˆ\~ï¼‰**

æŒ‰ä½éè¿ç®—ç¬¦ï¼ˆ\~ï¼‰ï¼Œåè½¬æ“ä½œæ•°çš„ä½ã€‚

const a = 5; // 00000000000000000000000000000101

const b = -3; // 11111111111111111111111111111101

console.log(\~a); // 11111111111111111111111111111010

// expected output: -6

console.log(\~b); // 00000000000000000000000000000010

// expected output: 2

æœ‰äº†è¿™äº›åŸºç¡€çš„çŸ¥è¯†ç‚¹åï¼Œå†æ¥è®¤è¯†å‡ ä¸ªå˜é‡ã€‚

**1. effectTrackDepth**

ç”¨äºè®°å½•ä½äºå“åº”ä¸Šä¸‹æ–‡ä¸­çš„Â [effect]{.mark}Â åµŒå¥—å±‚æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸ºÂ [0]{.mark}ã€‚

// effectTrackDepth = 0

effect(() =\> {

// effectTrackDepth = 1

effect(() =\> {})

})

**2. trackOpBit**

äºŒè¿›åˆ¶ä½ï¼Œæ¯ä¸€ä½ç”¨äºæ ‡è¯†å½“å‰Â [effect]{.mark}Â åµŒå¥—å±‚çº§çš„ä¾èµ–æ”¶é›†çš„å¯ç”¨çŠ¶æ€ã€‚é»˜è®¤å€¼ä¸ºÂ [1]{.mark}ï¼Œå³Â [00000000000000000000000000000001]{.mark}ã€‚

**3. maxMarkerBits**

è¡¨ç¤ºæœ€å¤§çš„Â [effect]{.mark}Â åµŒå¥—çš„å±‚æ¬¡æ•°ï¼Œæœ€å¤§å€¼ä¸ºÂ [30]{.mark}ã€‚

å¥½äº†ï¼Œææ‡‚äº†è¿™äº›æ“ä½œç¬¦ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹Â [Vue]{.mark}Â çš„ä¾èµ–æ¸…ç†æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå…ˆæ¥çœ‹ä¸è¶…è¿‡Â [maxMarkerBits]{.mark}Â å±‚çº§æ•°çš„åµŒå¥—Â [effect]{.mark}Â çš„ä¾èµ–æ”¶é›†çš„è¿‡ç¨‹ï¼Œè¿˜ä»¥ä¸Šé¢é‚£ä¸ªÂ [demo]{.mark}Â ä½œä¸ºç¤ºä¾‹ï¼š

const state = reactive({

a: 1,

show: true

});

effect(() =\> {

if (state.show) {

console.log(\`a: \${state.a}\`)

}

});

state.a ++

setTimeout(() =\> {

state.show = false

state.a ++

}, 1000)

**Step 1**ï¼š[run]{.mark}Â å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œ[trackOpBit = 1 \<\<
++effectTrackDepth]{.mark}Â è¿™ä¸ªè¯­å¥æ‰§è¡Œå®Œæˆåï¼Œå¾—åˆ°Â [effectTrackDepth =
1]{.mark}ï¼›[trackOpBit.toString(2) =
00000000000000000000000000000010]{.mark}ã€‚

**Step 2**ï¼šå› ä¸ºÂ [effectTrackDepth \<
maxMarkerBits]{.mark}Â ï¼Œæ‰€ä»¥æ‰§è¡ŒÂ [initDepMarkers]{.mark}Â å‡½æ•°ï¼Œå› ä¸ºè¿™é‡Œçš„Â [deps]{.mark}Â åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¿˜æ˜¯ä¸ªç©ºæ•°ç»„ï¼Œæ‰€ä»¥æ­¤å‡½æ•°æœªæ‰§è¡Œã€‚

export const initDepMarkers = ({ deps }) =\> {

if (deps.length) {

for (let i = 0; i \< deps.length; i++) {

deps\[i\].w \|= trackOpBit // set was tracked

}

}

}

**Step
3**ï¼šæ‰§è¡ŒÂ [this.fn]{.mark}Â å‡½æ•°ï¼Œå…ˆè®¿é—®Â [state.show]{.mark}ï¼Œè§¦å‘äº†Â [trackEffects]{.mark}ã€‚

export function trackEffects(dep) {

let shouldTrack = false

if (effectTrackDepth \<= maxMarkerBits) {

// å¦‚æœæœ¬è½®å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å·²ç»è®¿é—®å¹¶æ”¶é›†è¿‡ï¼Œåˆ™ä¸ç”¨å†æ”¶é›†è¯¥ä¾èµ–

if (!newTracked(dep)) {

// è®¾ç½® dep.n

dep.n \|= trackOpBit

shouldTrack = !wasTracked(dep)

}

} else {

// Full cleanup mode.

shouldTrack = !dep.has(activeEffect!)

}

if (shouldTrack) {

dep.add(activeEffect!)

activeEffect!.deps.push(dep)

}

}

è¿™é‡Œéœ€è¦é¢å¤–äº†è§£ 2
ä¸ªå‡½æ•°ï¼š[wasTracked]{.mark}ï¼ˆå·²ç»è¢«æ”¶é›†è¿‡ï¼Œç¼©å†™æ˜¯Â [w]{.mark}ï¼‰
å’ŒÂ [newTracked]{.mark}ï¼ˆæ–°æ”¶é›†çš„ä¾èµ–ï¼Œç¼©å†™æ˜¯Â [n]{.mark}ï¼‰ã€‚

export const wasTracked = dep =\> (dep.w & trackOpBit) \> 0

export const newTracked = dep =\> (dep.n & trackOpBit) \> 0

è¿›å…¥Â [trackEffects]{.mark}Â æ—¶ï¼Œå› ä¸ºæ­¤æ—¶è¿˜æ²¡æœ‰ä¸ºÂ [dep.n]{.mark}Â è¿›è¡Œæˆ–è¿ç®—èµ‹å€¼ï¼Œæ‰€ä»¥Â [state.show]{.mark}Â çš„Â [newTracked
= false]{.mark}ï¼Œ[wasTracked = false]{.mark}ã€‚

æ‰€ä»¥è®¡ç®—å¾—åˆ°Â [shouldTrack =
true]{.mark}ï¼Œæœ€åå°†Â [activeEffect]{.mark}Â æ”¶é›†è¿›å…¥Â [dep]{.mark}Â ä¸­ï¼ŒåŒæ—¶æ‰§è¡Œäº†Â [activeEffect.deps.push(dep)]{.mark}Â å°†Â [dep]{.mark}Â å­˜å…¥äº†Â [activeEffect]{.mark}Â çš„Â [deps]{.mark}Â ä¸­ã€‚ç„¶åè®¿é—®Â [state.a]{.mark}Â é‡å¤ä¸Šè¿°æ“ä½œã€‚ä¸Šè¿°æ­¥éª¤æ‰§è¡Œå®Œæˆåçš„Â [activeEffect.deps]{.mark}Â å¦‚ä¸‹ï¼š

\[

{\"w\":0,\"n\": 00000000000000000000000000000010, \[effect\]},

{\"w\":0,\"n\": 00000000000000000000000000000010, \[effect\]}

\]

**Step 4**ï¼šæœ€åæ‰§è¡ŒÂ [finalizeDepMarkers]{.mark}Â å‡½æ•°ï¼Œæ ¹æ®ç¬¬ 3
æ­¥ï¼Œæ­¤æ—¶Â [effect]{.mark}Â ä¸­çš„Â [deps]{.mark}Â åŒ…å«äº† 2
ä¸ªÂ [dep]{.mark}ï¼Œåˆ†åˆ«æ˜¯Â [state.show]{.mark}Â å’ŒÂ [state.a]{.mark}ã€‚Â [finalizeDepMarkers]{.mark}Â å‡½æ•°å†…éƒ¨æ‰§è¡Œäº†Â [wasTracked]{.mark}ï¼ˆå·²ç»è¢«æ”¶é›†è¿‡ï¼Œç¼©å†™æ˜¯Â [w]{.mark}ï¼‰
å’ŒÂ [newTracked]{.mark}ï¼ˆæ–°æ”¶é›†çš„ä¾èµ–ï¼Œç¼©å†™æ˜¯Â [n]{.mark}ï¼‰
å‡½æ•°ï¼Œå› ä¸ºÂ [dep.w = 0]{.mark}Â æ‰€ä»¥Â [wasTracked = false]{.mark}ã€‚

export const finalizeDepMarkers = (effect: ReactiveEffect) =\>
{

const { deps } = effect

if (deps.length) {

let ptr = 0

for (let i = 0; i \< deps.length; i++) {

const dep = deps\[i\]

if (wasTracked(dep) && !newTracked(dep)) {

dep.delete(effect)

} else {

// ç¼©å°ä¾èµ–é›†åˆçš„å¤§å°

deps\[ptr++\] = dep

}

// clear bits

dep.w &= \~trackOpBit

dep.n &= \~trackOpBit

}

deps.length = ptr

}

}

å› ä¸ºÂ [wasTracked =
false]{.mark}ï¼Œå› æ­¤Â [finalizeDepMarkers]{.mark}Â å¤„ç†åä»ç„¶å°†å‰¯ä½œç”¨å‡½æ•°ä¿ç•™åœ¨è¿™ä¸¤ä¸ªå±æ€§å¯¹åº”çš„ä¾èµ–é›†åˆä¸­ï¼ŒåŒæ—¶æŠŠÂ [dep.w]{.mark}Â å’ŒÂ [dep.n]{.mark}Â é‡ç½®å›
0ã€‚

\[{\"w\":0, \"n\":0, \[effect\]},{\"w\":0, \"n\":0,
\[effect\]}\]

**Step 5**ï¼šå½“æ‰§è¡ŒÂ [state.show =
false]{.mark}Â çš„æ—¶å€™ï¼Œè§¦å‘Â [effect.run]{.mark}Â çš„æ‰§è¡Œï¼Œæ­¤æ—¶æ‰§è¡ŒÂ [initDepMarkers]{.mark}Â æ—¶ï¼Œå› ä¸ºå·²ç»å­˜åœ¨äº†Â [dep]{.mark}ï¼Œæ‰€ä»¥å…ˆè®¿é—®Â [state.show]{.mark}ã€‚

å½“æ‰§è¡Œåˆ°Â [trackEffects]{.mark}Â æ—¶ï¼Œæ­¤æ—¶çš„Â [newTracked =
false]{.mark}ï¼Œæ‰§è¡Œé€»è¾‘å’Œä¹‹å‰ä¸€è‡´ã€‚åªä¸è¿‡å› ä¸ºÂ [state.show =
false]{.mark}ï¼Œæ‰€ä»¥æ²¡æœ‰è§¦å‘Â [state.a]{.mark}Â çš„è¿™ä¸€éƒ¨åˆ†é€»è¾‘çš„å¤„ç†ï¼Œæœ€åå¾—åˆ°çš„ç»“æœä¸ºï¼š

\[

{

\"w\": 00000000000000000000000000000010,

\"n\": 00000000000000000000000000000010,

\[effect\]

},

{

\"w\": 00000000000000000000000000000010,

\"n\": 0,

\[effect\]

}

\]

**Step 6**ï¼šæœ€åæ‰§è¡ŒÂ [finalizeDepMarkers]{.mark}Â æ—¶ï¼Œå¦‚ä¸‹ã€‚

if (wasTracked(dep) && !newTracked(dep)) {

dep.delete(effect)

}

å› ä¸ºè¿™é‡Œçš„Â [state.a]{.mark}Â çš„Â [wasTracked =
true]{.mark}Â ä¸”Â [newTracked]{.mark}Â ä¸ºÂ [false]{.mark}ï¼Œæ‰€ä»¥æ‰§è¡Œäº†Â [dep.delete(effect)]{.mark}Â å°†Â [effect]{.mark}Â ä»Â [dep]{.mark}Â ä¸­è¸¢æ‰ã€‚

**Step
7**ï¼š[1s]{.mark}Â åæ‰§è¡ŒÂ [state.a++]{.mark}Â çš„æ“ä½œï¼Œç”±äºÂ [state.a]{.mark}Â ä¸­æ²¡æœ‰Â [effect]{.mark}Â äº†ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ã€‚

**æ€»ç»“**ï¼šÂ [Vue]{.mark}Â åœ¨ç»„ä»¶çš„Â [effect]{.mark}Â æ‰§è¡Œä¹‹å‰ï¼Œä¼šæ ¹æ®Â [dep]{.mark}Â çš„æ”¶é›†æ ‡è®°ä½Â [w]{.mark}Â å’ŒÂ [n]{.mark}Â æ¥è¿›è¡Œæ¸…ç†ä¾èµ–ï¼Œåˆ é™¤ä¹‹å‰Â [state.a]{.mark}Â æ”¶é›†çš„Â [effect]{.mark}Â ä¾èµ–ã€‚è¿™æ ·å½“æˆ‘ä»¬ä¿®æ”¹Â [state.a]{.mark}Â æ—¶ï¼Œç”±äºå·²ç»æ²¡æœ‰ä¾èµ–äº†ï¼Œå°±ä¸ä¼šè§¦å‘Â [effect]{.mark}Â é‡æ–°æ‰§è¡Œã€‚

å¦å¤–ï¼Œä¸ºäº†æ›´å®¹æ˜“å¸®åŠ©å°ä¼™ä¼´ä»¬ç†è§£ä¸Šè¿°çš„æµç¨‹ï¼Œæˆ‘ä¹Ÿç²¾å¿ƒåˆ¶ä½œäº†ä¸€ä¸ªåŠ¨ç”»æ¼”ç¤ºä¸Šè¿°æµç¨‹å’Œè¿‡ç¨‹ï¼š

![æˆªå›¾.png](https://cdn-us.imgs.moe/2023/05/26/646f9fde38e7e.png)

æ³¨æ„ï¼Œå½“Â [effectTrackDepth]{.mark}Â å¤§äºÂ [30]{.mark}Â æ—¶ï¼Œä¼šè°ƒç”¨Â [cleanup]{.mark}Â æ¥æ¸…ç†ä¾èµ–ï¼Œå…¶å®Â [cleanup]{.mark}Â çš„åŸç†å°±æ˜¯ä¾èµ–æ”¶é›†å‰å…¨éƒ¨åˆ é™¤æ‰€æœ‰çš„Â [dep]{.mark}ï¼Œä¾èµ–æ”¶é›†æ—¶å†ä¸€ä¸ªä¸ªåŠ è¿›æ¥ï¼Œè¿™ä¸ªæ€§èƒ½å…¶å®æ˜¯æ¯”è¾ƒå·®çš„ï¼Œæ‰€ä»¥Â [Vue
3.2]{.mark}Â æ”¹æˆäº†é€šè¿‡äºŒè¿›åˆ¶æ ‡è®°ä½çš„æ–¹å¼æ¥é€‰æ‹©æ€§åˆ é™¤å’Œæ·»åŠ ï¼Œæå‡äº†æ€§èƒ½ã€‚å…³äºè¿™éƒ¨åˆ†æ›´å¤šçš„ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒ[è¿™ä¸ªPR]{.mark}ã€‚

**æ€»ç»“**

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šè®²å®Œäº†Â [Vue
3]{.mark}Â çš„å“åº”å¼åŸç†åŸºç¡€ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´äº†è§£Â [Vue
2]{.mark}Â çš„å“åº”å¼åŸç†ï¼Œåº”è¯¥æ¸…æ¥šÂ [Vue2]{.mark}Â çš„å“åº”å¼åŸç†å¯ä»¥ç†è§£æˆå¦‚ä¸‹ä¸€å¹…å›¾ï¼š

![æˆªå›¾.png](https://cdn-us.imgs.moe/2023/05/26/646f9fde76b9c.png)

åœ¨Â [Vue
2]{.mark}Â ä¸­ï¼Œ[Watcher]{.mark}Â å°±æ˜¯ä¾èµ–ï¼Œæœ‰ä¸“é—¨é’ˆå¯¹ç»„ä»¶æ¸²æŸ“çš„Â [render
watcher]{.mark}ã€‚

ä¾èµ–æ”¶é›†ï¼šç»„ä»¶åœ¨Â 

renderÂ çš„æ—¶å€™ä¼šè®¿é—®æ¨¡æ¿ä¸­çš„æ•°æ®ï¼Œè§¦å‘Â 

getterÂ æŠŠÂ 

watcherÂ ä½œä¸ºä¾èµ–æ”¶é›†ã€‚

è§¦å‘æ¸²æŸ“ï¼šå½“ä¿®æ”¹æ•°æ®æ—¶ï¼Œä¼šè§¦å‘Â 

setterï¼Œé€šçŸ¥Â 

watcherÂ æ›´æ–°ï¼Œè¿›è€Œè§¦å‘äº†ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚

ç›¸åº”åœ°ï¼Œåœ¨Â [Vue 3]{.mark}Â ä¸­çš„å“åº”å¼æµç¨‹å¦‚ä¸‹ï¼š

![æˆªå›¾.png](https://cdn-us.imgs.moe/2023/05/26/646f9fde778cf.png)

å¯ä»¥çœ‹åˆ°ï¼Œ[Vue 3]{.mark}Â ç›¸å¯¹äºÂ [Vue
2]{.mark}Â çš„å“åº”å¼å·®åˆ«ä¸å¤§ï¼Œä¸»è¦å°±æ˜¯åŠ«æŒæ•°æ®çš„æ–¹å¼æ”¹æˆç”¨Â [Proxy]{.mark}Â å®ç°ï¼Œä»¥åŠæ”¶é›†çš„ä¾èµ–ç”±Â [watcher]{.mark}Â å®ä¾‹å˜æˆäº†ç»„ä»¶å‰¯ä½œç”¨å‡½æ•°Â [effect]{.mark}ã€‚å¦å¤–ï¼Œå€¼å¾—ä¸€æçš„æ˜¯Â [Vue
3]{.mark}Â åœ¨å“åº”å¼è®¾è®¡ä¸Šåˆå¤šè€ƒè™‘äº†å±‚çº§åµŒå¥—çš„ä¾èµ–æ”¶é›†é—®é¢˜å’Œä¸å¿…è¦çš„ä¾èµ–æ¸…ç†é—®é¢˜ã€‚
